# 基于IPv4的流媒体点播系统
# 1. 项目简介
这是我基于李慧琴老师的apue课程最后的广播系统项目改编的，广播项目可见https://github.com/missFuture/IPv4_streaming_media
。本项目涉及到了一些广播项目没有涉及到的课堂上讲的知识，比如epoll，状态机，动态进程池，还使用到了mysql和redis的一些简单技术。本项目仍然是基于客户端/服务器模型，采用TCP传输mp3格式的数据。
# 2. 需求分析
• 需要实现客户端点歌后客户端发送音乐数据，所以使用**TCP**进行通信

• 由于广播的内容是音乐，所以需要进行流量控制。流量控制采用**令牌桶**实现，可设置传输的速率。

• 当客户端连接上服务端后，服务端需要向客户端发送音乐列表，音乐列表存储在mysql中因为每个客户端连接上后服务端都需要发送音乐列表，而mysql是将数据保存在磁盘当中的，读取速度较慢，所以使用redis作为音乐列表的缓存，提高读取速度。

• 客户端可以向服务端发送六种指令：**play [歌曲名]**, **pause**, **resume**, **next**, **prev**，客户端按下ctrl-c后会发送**stop**，因此在服务端使用**epoll**去监听客户端是否发送请求，使用有限状态机去执行发送的请求。

• 客户端同样通过父进程读取服务端发来的数据，创建一个子进程使用mpg321进行解码播放，不同的是客户端需要监测终端用户有没有输入指令，所以在这里仍然采用**epoll**去监听。

• 关于令牌桶的初始化我参考了广播项目中的参数，但我发现此参数不适用于每首歌，所以使用了mp3_parser中的函数来获得要播放的歌曲的比特率，使用这个值作为cps值客户端听到的音乐就不会一卡一卡了。（我也不知道为什么）
# 3. 编译
```sh
cd clinet/  
make  
cd ../server  
make  
```
# 4. 设置本地媒体库以及数据库
所有音乐直接放在主目录的music文件夹中。数据库名字叫做**music**，表名为**entry**,包括**id**，**name**，**singer**，**path**字段，path保存的是音乐的**绝对路径**。因为我音乐放不的不多，所以我直接把数据输入到mysql中的，当然也可以通过代码解析目录然后把信息导入mysql中。
# 5. 后期优化方向
• 由于mpg321会一直解码管道中的数据，所以在切歌、暂停、退出客户端时，mpg321都会持续读取管道中的内容，我在这里解决办法是切歌和暂停时将管道中的数据全部读完，暂停时向子进程发送pause信号，但效果仍然不是很好，可能得换一种解码的方式。
• 客户端界面
# 6. 讨论
欢迎大家fork本代码，代码中可能存在内存泄漏以及有bug的地方，目前本人还没有测试出来，如果有问题欢迎留言一起讨论


git remote add origin https://github.com/asdfghadf/IPv4_musicplayer.git


